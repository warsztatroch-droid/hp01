# PrzykÅ‚adowe automatyzacje dla Warmlink
# ZamieÅ„ DEVICE_CODE na kod swojego urzÄ…dzenia
# Dodaj do configuration.yaml lub automations.yaml

automation:
  # === POWIADOMIENIA ===
  
  # Powiadom o awarii
  - alias: "Warmlink - Powiadom o awarii"
    trigger:
      - platform: state
        entity_id: binary_sensor.warmlink_DEVICE_CODE_fault
        to: "on"
    action:
      - service: notify.mobile_app_twoj_telefon
        data:
          title: "âš ï¸ Awaria pompy ciepÅ‚a!"
          message: "Wykryto awariÄ™ pompy ciepÅ‚a Warmlink. SprawdÅº urzÄ…dzenie."
          data:
            tag: warmlink_fault
            importance: high

  # Powiadom gdy pompa offline
  - alias: "Warmlink - Pompa offline"
    trigger:
      - platform: state
        entity_id: binary_sensor.warmlink_DEVICE_CODE_online
        to: "off"
        for: "00:05:00"
    action:
      - service: notify.mobile_app_twoj_telefon
        data:
          title: "ðŸ“¡ Pompa ciepÅ‚a offline"
          message: "Warmlink nie odpowiada od 5 minut. SprawdÅº poÅ‚Ä…czenie."

  # === OSTRZEÅ»ENIA O WYDAJNOÅšCI ===
  
  # Niski COP
  - alias: "Warmlink - Niski COP"
    trigger:
      - platform: numeric_state
        entity_id: sensor.warmlink_DEVICE_CODE_cop_eer_total
        below: 2.5
        for: "00:30:00"
    condition:
      - condition: state
        entity_id: switch.warmlink_DEVICE_CODE_power_switch
        state: "on"
    action:
      - service: notify.mobile_app_twoj_telefon
        data:
          title: "ðŸ“‰ Niski COP pompy ciepÅ‚a"
          message: "COP spadÅ‚ poniÅ¼ej 2.5 od 30 minut (aktualnie {{ states('sensor.warmlink_DEVICE_CODE_cop_eer_total') }})"

  # Wysoka temperatura tÅ‚oczenia
  - alias: "Warmlink - Wysoka temp. tÅ‚oczenia"
    trigger:
      - platform: numeric_state
        entity_id: sensor.warmlink_DEVICE_CODE_t12
        above: 100
    action:
      - service: notify.mobile_app_twoj_telefon
        data:
          title: "ðŸŒ¡ï¸ Wysoka temperatura tÅ‚oczenia"
          message: "Temperatura tÅ‚oczenia wynosi {{ states('sensor.warmlink_DEVICE_CODE_t12') }}Â°C"

  # === AUTOMATYCZNE STEROWANIE ===
  
  # Tryb cichy w nocy
  - alias: "Warmlink - Tryb cichy nocÄ…"
    trigger:
      - platform: time
        at: "22:00:00"
    action:
      - service: switch.turn_on
        target:
          entity_id: switch.warmlink_DEVICE_CODE_h22_switch

  - alias: "Warmlink - WyÅ‚Ä…cz tryb cichy rano"
    trigger:
      - platform: time
        at: "07:00:00"
    action:
      - service: switch.turn_off
        target:
          entity_id: switch.warmlink_DEVICE_CODE_h22_switch

  # ObniÅ¼ temperaturÄ™ gdy nikogo nie ma
  - alias: "Warmlink - Tryb away"
    trigger:
      - platform: state
        entity_id: group.all_persons  # lub zone.home
        to: "not_home"
        for: "00:30:00"
    action:
      - service: number.set_value
        target:
          entity_id: number.warmlink_DEVICE_CODE_r02
        data:
          value: 35  # ObniÅ¼ona temperatura ogrzewania

  - alias: "Warmlink - PowrÃ³t do domu"
    trigger:
      - platform: state
        entity_id: group.all_persons
        to: "home"
    action:
      - service: number.set_value
        target:
          entity_id: number.warmlink_DEVICE_CODE_r02
        data:
          value: 45  # Normalna temperatura ogrzewania

  # === DEZYNFEKCJA ===
  
  # Cotygodniowa dezynfekcja (anty-legionella)
  - alias: "Warmlink - Cotygodniowa dezynfekcja"
    trigger:
      - platform: time
        at: "03:00:00"
    condition:
      - condition: time
        weekday:
          - sun  # Niedziela w nocy
    action:
      - service: switch.turn_on
        target:
          entity_id: switch.warmlink_DEVICE_CODE_g05_switch
      - delay: "01:00:00"  # Poczekaj godzinÄ™
      - service: switch.turn_off
        target:
          entity_id: switch.warmlink_DEVICE_CODE_g05_switch

# === SENSORY POMOCNICZE ===
# Dodaj do configuration.yaml

sensor:
  # Sensor zuÅ¼ycia energii (do Energy Dashboard)
  - platform: integration
    source: sensor.warmlink_DEVICE_CODE_power_in_total
    name: Warmlink Energy Consumption
    unit_prefix: k
    round: 2
    method: left

  # Åšredni COP z ostatniej godziny
  - platform: statistics
    name: "Warmlink Åšredni COP (1h)"
    entity_id: sensor.warmlink_DEVICE_CODE_cop_eer_total
    state_characteristic: mean
    max_age:
      hours: 1

  # Template sensor - rÃ³Å¼nica temperatur
  - platform: template
    sensors:
      warmlink_delta_t:
        friendly_name: "Warmlink Delta T"
        unit_of_measurement: "Â°C"
        value_template: >-
          {{ (states('sensor.warmlink_DEVICE_CODE_t02') | float - 
              states('sensor.warmlink_DEVICE_CODE_t01') | float) | round(1) }}
